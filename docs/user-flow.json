{
  "app": {
    "name": "Guardian",
    "mission": "Deliver alarm-grade, date-specific reminders that fire under Doze, survive reboot/timezone changes, and drive explicit acknowledgement.",
    "success_definition": {
      "primary": [
        "User schedules a far-future date-time alarm and it fires near intended time.",
        "Alarm is actionable via Stop, Snooze, or Do.",
        "Alarms survive reboot and time/timezone changes by rescheduling."
      ],
      "secondary": [
        "Reliability status is visible and fixable by the user.",
        "History provides proof for scheduled, fired, and outcome events."
      ],
      "acceptance_metrics": {
        "fire_accuracy": {
          "goal": ">=99% MAIN trigger delivery",
          "drift_budget_ms": {
            "typical": 1000,
            "worst_case_allowed": 60000
          }
        },
        "stability": {
          "crash_free_sessions_goal": ">=99.5%",
          "anr_rate_goal": "<=0.1%"
        },
        "user_outcomes": {
          "acknowledgement_rate_goal": ">=95% explicit action after fire",
          "diagnostics_coverage_goal": "100% alarms have schedule+outcome trace"
        }
      }
    }
  },
  "global_policies": {
    "time_representation": {
      "storage": "UTC millis",
      "store_creation_timezone": true,
      "timezone_behavior_policy": {
        "name": "FIXED_LOCAL_TIME",
        "meaning": "10:00 local remains 10:00 local after timezone change"
      }
    },
    "scheduling_policy": {
      "mechanism": "AlarmManager.setExactAndAllowWhileIdle",
      "fallback_when_exact_not_allowed": [
        "Mark risk in reliability dashboard",
        "Offer degraded reminder mode",
        "Guide user to exact alarm settings"
      ]
    },
    "delivery_policy": {
      "main_alarm": "foreground service + full-screen notification",
      "pre_alert": "high-priority notification",
      "nag": "chained exact triggers until acknowledged or stop conditions"
    }
  },
  "end_to_end_flow": [
    {
      "stage": "S0_FIRST_LAUNCH",
      "user_sees": [
        "Welcome",
        "Reliability checklist",
        "Test alarm"
      ],
      "system_background": [
        "Create notification channels",
        "Read capability state",
        "Persist defaults"
      ],
      "success": [
        "Reliability status computed",
        "Optional test flow can fire end-to-end"
      ]
    },
    {
      "stage": "S1_CREATE_ALARM",
      "user_sees": [
        "Create form",
        "Optional primary action fields",
        "Policy toggles"
      ],
      "system_background": [
        "Validate input",
        "Normalize time + build policy",
        "Persist alarm",
        "Schedule triggers"
      ],
      "success": [
        "Alarm listed enabled",
        "Triggers registered"
      ]
    },
    {
      "stage": "S2_IDLE_PERIOD",
      "user_sees": [
        "Alarm countdown",
        "Risk warning only if state changed"
      ],
      "system_background": [
        "OS holds alarms",
        "Optional lightweight health checks"
      ],
      "success": [
        "No heavy polling",
        "Risk changes surfaced"
      ]
    },
    {
      "stage": "S3_PRE_ALERT_FIRE",
      "user_sees": [
        "Upcoming reminder notification"
      ],
      "system_background": [
        "Receiver validates and logs",
        "Pre-alert notification posted"
      ],
      "success": [
        "Pre-alert delivered",
        "History has PRE fire record"
      ]
    },
    {
      "stage": "S4_MAIN_ALARM_FIRE",
      "user_sees": [
        "Full-screen ringing",
        "Stop/Snooze/Do actions"
      ],
      "system_background": [
        "Receiver logs and starts foreground service",
        "Service handles audio/vibration lifecycle"
      ],
      "success": [
        "Alarm perceptible",
        "Actions available",
        "MAIN fire recorded"
      ]
    },
    {
      "stage": "S5_USER_ACKNOWLEDGEMENT",
      "branches": {
        "STOP": [
          "Record dismissed",
          "Stop service"
        ],
        "SNOOZE": [
          "Record snoozed",
          "Schedule exact snooze trigger",
          "Stop service"
        ],
        "DO": [
          "Stop service",
          "Open primary action intent",
          "Record action launched"
        ]
      },
      "success": [
        "Outcome logged",
        "System state consistent"
      ]
    },
    {
      "stage": "S6_NAG_MODE",
      "precondition": "nag_enabled",
      "system_background": [
        "Schedule next nag if no acknowledgement",
        "Escalate deterministically",
        "Stop on limits or user action"
      ],
      "success": [
        "Nag chain works",
        "All attempts logged"
      ]
    },
    {
      "stage": "S7_PROOF_AND_DIAGNOSTICS",
      "user_sees": [
        "History timeline",
        "Reliability status",
        "Diagnostics export"
      ],
      "system_background": [
        "Persist lifecycle events",
        "Generate export payload"
      ],
      "success": [
        "User/support can verify outcomes"
      ]
    },
    {
      "stage": "S8_RESILIENCE_EVENTS",
      "events": {
        "BOOT_COMPLETED": [
          "Load enabled alarms",
          "Recompute plans",
          "Reschedule all"
        ],
        "TIME_OR_TIMEZONE_CHANGED": [
          "Apply timezone policy",
          "Recompute and reschedule"
        ],
        "PACKAGE_REPLACED": [
          "Reschedule enabled alarms"
        ]
      },
      "success": [
        "No pending alarm loss after system events"
      ]
    }
  ],
  "component_responsibilities": {
    "ui": [
      "collect input",
      "show reliability",
      "present actions",
      "show history"
    ],
    "domain": [
      "compute policies",
      "define transitions",
      "enforce invariants"
    ],
    "data": [
      "persist alarms",
      "persist history",
      "query enabled alarms"
    ],
    "platform": [
      "schedule/cancel exact triggers",
      "notifications",
      "capability probes"
    ],
    "receivers": [
      "fast broadcast handling",
      "start service",
      "reschedule"
    ],
    "service": [
      "ring reliably",
      "handle action lifecycle",
      "cleanup resources"
    ]
  },
  "done_when": {
    "functional": [
      "create/edit/enable/disable/delete works",
      "main+pre alerts fire",
      "snooze and optional action launch work"
    ],
    "reliability": [
      "reboot/timezone rescheduling works",
      "risk dashboard detects degraded state"
    ],
    "observability": [
      "history exists for all lifecycle events",
      "diagnostics export available"
    ],
    "release": [
      "qa matrix passed",
      "store compliance ready"
    ]
  }
}
